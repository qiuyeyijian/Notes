# 第四次学习札记



## Modebus通信

通过串口调试助手，与使用新的通信协议的MCU完成通信，达到控制Flash的目的

### 读物理地址

数据长度需要 6个字节，第一个字节表示读指令 a（0x61）， 接着四个字节表示物理地址（0x0000_0000 - 0x0000_FFFF）, 最后一个字节表示读出的字节数。注意CRC16只是对数据区域校验。

```c
//======================================================================
// dest：读出数据存放处（传地址，目的是带出所读数据，RAM区）
// addr：目标地址，要求为4的倍数（例如：0x00000004）
// N：读字节数目（0~1020,要求为4，8,12,......）
// 功能概要：读取flash指定地址的内容
//======================================================================
void flash_read_physical(uint8_t *dest,uint32_t addr,uint16_t N);

// 读从物理地址为0x0000FC00，30字节的内容
A5 06 00 06 61 00 00 FC 00 1E 52 48 B6 07
```

| 帧头  | 数据长度 | 数据              | CRC16校验 | 帧尾  |
| ----- | -------- | ----------------- | --------- | ----- |
| A5 06 | 00 06    | 61 00 00 FC 00 1E | 52 48     | B6 07 |



### 读逻辑地址

数据长度需要5个字节，第一个字节表示读逻辑地址指令r （0x72），第二个字节表示扇区号 ，第三个和第四个表示偏移量，最后一个表示读取的数据量

```c
//======================================================================
// sect：扇区号（范围取决于实际芯片，见mcu.h）
// offset:扇区内部偏移地址（要求为0,4，8,12，......）
// N：读字节数目（要求为4，8,12,......）
// dest：读出数据存放处（传地址，目的是带出所读数据，RAM区）
// 功能概要：读取flash存储器的sect扇区的 offset处开始的N字节，到RAM区dest处
//========================================================================
void flash_read_logic(uint8_t *dest,uint16_t sect,uint16_t offset,uint16_t N);

读 从第63扇区，偏移量为0的 30字节数据
A5 06 00 05 72 3F 00 00 1E 17 90 B6 07
```

| 帧头  | 数据长度 | 数据           | CRC16校验 | 帧尾  |
| ----- | -------- | -------------- | --------- | ----- |
| A5 06 | 00 05    | 72 3F 00 00 1E | 17 90     | B6 07 |



### 擦除扇区

数据长度为2个字节，第一个表示擦除扇区指令 e（0x0E），第一个字节表示要擦除的扇区号。

注意：KL36擦除是以扇区为单位的

```c
//======================================================================
//函数返回：函数执行执行状态：0=正常；1=异常。
//参数说明：sect：目标扇区号（范围取决于实际芯片，见mcu.h）
//功能概要：擦除flash存储器的sect扇区
//======================================================================
uint8_t flash_erase(uint16_t sect);

A5 06 00 02 65 3F F0 6A B6 07
```

| 帧头  | 数据长度 | 数据  | CRC16校验 | 帧尾  |
| ----- | -------- | ----- | --------- | ----- |
| A5 06 | 00 02    | 65 3F | F0 6A     | B6 07 |



### 写数据

数据长度为 5 + n 个字节，第一个表示写数据指令 w （0x77）第二个表示扇区号，第三个和第四个表示偏移量，第5个表示要写入的字节数目，接下来n个字节表示要写入的数据

```c
//======================================================================
//函数返回：函数执行状态：0=正常；1=异常。
// sect：扇区号（范围取决于实际芯片，见mcu.h）
// offset:写入扇区内部偏移地址（要求为0,4，8,12，......）
// N：写入字节数目（要求为4，8,12,......）
// buf：源数据缓冲区首地址
//功能概要：将buf开始的N字节写入到flash存储器的sect扇区的 offset处
//======================================================================
uint8_t flash_write(uint16_t sect,uint16_t offset,uint16_t N,uint8_t *buf);
 
// 从第63 号扇区 偏移量为0 写入7个字节数据: longwei
A5 06 00 0C 77 3F 00 00 07 6C 6F 6E 67 77 65 69 C4 56 B6 07
```

| 帧头  | 数据长度 | 数据                                | CRC16校验 | 帧尾  |
| ----- | -------- | ----------------------------------- | --------- | ----- |
| A5 06 | 00 0C    | 77 3F 00 00 07 6C 6F 6E 67 77 65 69 | C4 56     | B6 07 |













