## 一、设计目的

* 了解DMA传送原理
* 掌握DMA编程方法
* 熟悉UART的DMA基本原理



## 二、设计内容

## DMA 请求号

KL36包含一个DMA多路请求复用器（DMAMUX0），拥有4个可独立编程的DMA通道，每个通道支持多达63个请求信号。有些模块的请求支持异步DMA请求操作，下面表格中都有注明。

![image-20201213140122915](assets/%E8%AF%BE%E8%AE%BE%E6%8A%A5%E5%91%8A/image-20201213140122915.png)

![image-20201213140226968](assets/%E8%AF%BE%E8%AE%BE%E6%8A%A5%E5%91%8A/image-20201213140226968.png)



DMA请求都是DMA控制器（DMA）来处理，但是由上表可以看出，能发起DMA请求的模块有很多。为了统一管理，KL36都是由一个DMA多路请求复用器与外设模块进行交互，然后统一交给DMA控制器。

![image-20201228095203270](assets/%E8%AF%BE%E8%AE%BE%E6%8A%A5%E5%91%8A/image-20201228095203270.png)



![image-20201228095415826](assets/%E8%AF%BE%E8%AE%BE%E6%8A%A5%E5%91%8A/image-20201228095415826.png)

## DMA 寄存器

### DMA寄存器总览

从下表可以看到，DMA主要用到的寄存器有：源地址寄存器（DMA_SARn），目的地址寄存器（DMA_DARn），状态/字节数寄存器（DMA_DSR_BCRn），控制寄存器（DMA_DCRn）。

**其中，DMA的状态和字节数放在一个32位的寄存器里面进行控制，所以叫做状态/字节数寄存器。字节数占低16位，状态占高16位**，下面会对各个寄存器进行详细介绍。

| 绝对地址（HEX） | 寄存器名                                   | 宽度 | 读/写 | 重置值（HEX） |
| --------------- | ------------------------------------------ | ---- | ----- | ------------- |
| 4000_8100       | 源地址寄存器（DMA_SAR0）                   | 32   | R/W   | 0000_0000     |
| 4000_8104       | 目的地址寄存器（DMA_DAR0）                 | 32   | R/W   | 0000_0000     |
| 4000_8108       | DMA状态寄存器/字节数寄存器（DMA_DSR_BCR0） | 32   | R/W   | 0000_0000     |
| 4000_810C       | DMA控制寄存器（DMA_DCR0）                  | 32   | R/W   | 0000_0000     |
| 4000_8110       | 源地址寄存器（DMA_SAR1）                   | 32   | R/W   | 0000_0000     |
| 4000_8114       | 目的地址寄存器（DMA_DAR1）                 | 32   | R/W   | 0000_0000     |
| 4000_8118       | DMA状态寄存器/字节数寄存器（DMA_DSR_BCR1） | 32   | R/W   | 0000_0000     |
| 4000_811C       | DMA控制寄存器（DMA_DCR1）                  | 32   | R/W   | 0000_0000     |
| 4000_8120       | 源地址寄存器（DMA_SAR2）                   | 32   | R/W   | 0000_0000     |
| 4000_8124       | 目的地址寄存器（DMA_DAR2）                 | 32   | R/W   | 0000_0000     |
| 4000_8128       | DMA状态寄存器/字节数寄存器（DMA_DSR_BCR2） | 32   | R/W   | 0000_0000     |
| 4000_812C       | DMA控制寄存器（DMA_DCR2）                  | 32   | R/W   | 0000_0000     |
| 4000_8130       | 源地址寄存器（DMA_SAR3）                   | 32   | R/W   | 0000_0000     |
| 4000_8134       | 目的地址寄存器（DMA_DAR3）                 | 32   | R/W   | 0000_0000     |
| 4000_8138       | DMA状态寄存器/字节数寄存器（DMA_DSR_BCR3） | 32   | R/W   | 0000_0000     |
| 4000_813C       | DMA控制寄存器（DMA_DCR3）                  | 32   | R/W   | 0000_0000     |



### DMA通道

KL36拥有4个可独立编程的DMA通道，关于DMA通道有很多官方解释，下面谈一下个人理解。

其实，DMA通道是一个抽象的概念，我们可以认为DMA通道就是一组寄存器的集合。比如，KL36的DMA0号通道主要由源地址寄存器（DMA_SAR0），目的地址寄存器（DMA_DAR0），状态/字节数寄存器（DMA_DSR_BCR0），控制寄存器（DMA_DCR0）， 加上DMAD多路复用的通道配置寄存器（DMAMUXx_CFCFGn）组成。这些寄存器控制DMA的发送与接收，记录DMA发送或者接收状态，每一组寄存器都是独立编程的。



### 通道配置寄存器DMAMUXx_CHCFGn

![image-20201228144650404](assets/%E8%AF%BE%E8%AE%BE%E6%8A%A5%E5%91%8A/image-20201228144650404.png)



#### ENBL

ENBL: DMA 通道使能。0，DMA通道禁止；1,DMA通道使能。

#### TRIG

DMA通道触发使能。

0，触发禁止，普通触发模式；在普通触发模式下，DMA只会触发一次，之后需要再次对DMA使能。比如，普通模式下，通过DMA向外设发送数据，使能之后，只会发送一次数据，如果需要再次发送，需要再次使能。

1，触发使能，周期触发模式。在周期触发模式下，DMA会周期性触发。比如通过DMA向外设发送数据，使能之后，DMA会不断地被触发，不断地发送数据。

#### SOURCE

DMA 通道源，用来选择通道号。共6位，可以编码64个请求信号。一般全0不用，剩下63个请求信息号可以参考上面介绍的DMA请求号











## 三、设计总结与体会

通过本次课程设计，熟悉了KL36基本底层驱动的编写流程，掌握了DMA的基本原理与工作流程，深刻体会到了MCU的底层各个寄存器之间的相互协同。

在编写UART的DMA驱动时候，由于资料较少，详细阅读了KL36的参考手册，切身体会到了参考手册对嵌入式开发人员的重要性。同时，在编程过程中，遇到了许多问题，经过查阅资料，和同学交流都逐一化解了。虽然遇到问题会让人抓狂，但是问题解决之后也是让人心情愉悦。



